<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image Tracking AR - Automatic Video Fit</title>

  <!-- A-Frame e AR.js NFT -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <script>
    // Componente per far s√¨ che il video si adatti automaticamente al marker
    AFRAME.registerComponent('fit-video-to-marker', {
      init: function() {
        const nft = this.el; // <a-nft>
        const video = nft.querySelector('#vid');

        // Assicuriamoci che il video sia pronto
        video.addEventListener('loadedmetadata', () => {
          // Listener per quando il marker viene trovato
          nft.addEventListener('markerFound', () => {
            // Calcola bounding box dell'oggetto NFT
            const bbox = new THREE.Box3().setFromObject(nft.object3D);
            const size = new THREE.Vector3();
            bbox.getSize(size);

            // Imposta larghezza e altezza del video in base al marker
            const vidEl = nft.querySelector('a-video');
            vidEl.setAttribute('width', size.x);
            vidEl.setAttribute('height', size.y);

            // Posiziona il video esattamente sul marker
            vidEl.object3D.position.set(0, 0, 0);

            // Ruota il video parallelo al piano del marker
            vidEl.object3D.rotation.x = -Math.PI / 2;

            // Mostra il video
            video.play();
          });

          // Quando il marker scompare, pausa il video
          nft.addEventListener('markerLost', () => {
            video.pause();
          });
        });

        // Permetti autoplay anche su mobile
        window.addEventListener('click', () => video.play());
        window.addEventListener('touchstart', () => video.play());
      }
    });
  </script>

  <style>
    .arjs-loader {
      height: 100%; width: 100%; position: absolute; top: 0; left: 0;
      background-color: rgba(0, 0, 0, 0.8); z-index: 9999; display: flex;
      justify-content: center; align-items: center;
    }
    .arjs-loader div {
      text-align: center; font-size: 1.25em; color: white;
    }
  </style>
</head>

<body style="margin: 0; overflow: hidden;">
  <div class="arjs-loader">
    <div>Loading descriptors, please wait...</div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-assets>
      <video id="vid" src="planet.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous" preload="auto"></video>
    </a-assets>

    <a-nft
      type="nft"
      url="https://lauraMister.github.io/imageAR/planet"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5"
      fit-video-to-marker
    >
      <a-video id="vid" src="#vid"></a-video>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
